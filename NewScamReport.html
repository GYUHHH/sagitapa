<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>새로운 사기수법을 제보합니다</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">🏠 홈으로</a>
            <h1>새로운 사기수법을 제보합니다</h1>
        </div>

        <div class="write-form">
            <form onsubmit="submitReport(event)">
                <div class="form-row">
                    <textarea id="title" placeholder="내용을 입력하세요..." maxlength="100" required rows="1"></textarea>
            </div>
            <div class="form-row">
                <input type="password" id="password" placeholder="비밀번호" maxlength="20" required>
                <button type="submit" class="submit-btn" id="submitBtn">📝 제출하기</button>
            </div>
        </form>
    </div>

        <div id="successMessage" style="display: none;"></div>

        <div class="board-list">
            <div id="boardList">
                <div class="loading">게시글을 불러오는 중...</div>
            </div>

            <div class="board-stats">
                Copyright © 2025 sagitapa. All rights reserved.
            </div>
        </div>
    </div>

    <!-- 수정 모달 -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">게시글 수정</div>
            <div class="modal-body">
                <input type="text" id="editTitle" class="modal-input" placeholder="수정할 제목">
                <input type="password" id="editPassword" class="modal-input" placeholder="비밀번호">
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal()">취소</button>
                <button class="modal-btn primary" onclick="confirmEdit()">수정</button>
            </div>
        </div>
    </div>

    <!-- 삭제 모달 -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">게시글 삭제</div>
            <div class="modal-body">
                <p>정말로 삭제하시겠습니까?</p>
                <input type="password" id="deletePassword" class="modal-input" placeholder="비밀번호">
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal()">취소</button>
                <button class="modal-btn primary" onclick="confirmDelete()">삭제</button>
            </div>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://rmulijeebyohilnyqkev.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtdWxpamVlYnlvaGlsbnlxa2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTAwODMsImV4cCI6MjA2NzI4NjA4M30.Cf4mZutF14QVT7bfY1GJk6iBkKT8ALUA0uGkvLHKWDg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let reports = [];
        let currentEditId = null;
        let currentDeleteId = null;

        // 페이지 로드시 데이터 가져오기
        async function loadReports() {
            try {
                console.log('데이터 로딩 시작...');
                
                const { data, error } = await supabase
                    .from('newreports')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase 오류:', error);
                    throw error;
                }
                
                console.log('로드된 데이터:', data);
                reports = data || [];
                renderReports();
                
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                reports = [];
                renderReports();
            }
        }

        function getCurrentDateTime() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const period = hours >= 12 ? '오후' : '오전';
            const displayHours = String(hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours)).padStart(2, '0');
            
            return `${year}. ${month}. ${day}. ${period} ${displayHours}:${minutes}`;
        }

        async function submitReport(event) {
            event.preventDefault();
            
            const titleInput = document.getElementById('title');
            const passwordInput = document.getElementById('password');
            const submitBtn = document.getElementById('submitBtn');
            const title = titleInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!title) {
                alert('내용을 입력해 주세요.');
                return;
            }
            
            if (!password) {
                alert('비밀번호를 입력해 주세요.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '등록 중...';

            try {
                console.log('데이터 저장 시작:', title);
                
                const { data, error } = await supabase
                    .from('newreports')
                    .insert([
                        {
                            title: title,
                            password: password,
                            date: getCurrentDateTime()
                        }
                    ])
                    .select();

                if (error) {
                    console.error('저장 오류:', error);
                    throw error;
                }

                console.log('저장 성공:', data);

                if (data && data[0]) {
                    reports.unshift(data[0]);
                    renderReports();
                }
                
                titleInput.value = '';
                passwordInput.value = '';
                
            } catch (error) {
                console.error('저장 오류:', error);
                alert('저장 중 오류가 발생했습니다. 다시 시도해주세요.\n오류: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '📝 등록하기';
            }
        }

        function renderReports() {
            const boardList = document.getElementById('boardList');
            
            if (reports.length === 0) {
                boardList.innerHTML = '<div class="no-posts">등록된 제보가 없습니다.</div>';
                return;
            }
            
            boardList.innerHTML = reports.map(report => `
                <div class="board-item">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <span class="board-number">No.${report.id || '?'}</span>
                        <span class="board-title">${report.title || '(제목 없음)'}</span>
                        <div class="board-actions">
                            <button class="action-btn edit-btn" onclick="openEditModal(${report.id}, '${report.title}')">수정</button>
                            <button class="action-btn delete-btn" onclick="openDeleteModal(${report.id})">삭제</button>
                        </div>
                    </div>
                    <span class="board-date">${report.date}</span>
                </div>
            `).join('');
        }

        function openEditModal(id, title) {
            currentEditId = id;
            document.getElementById('editTitle').value = title.replace(/'/g, "");
            document.getElementById('editPassword').value = '';
            document.getElementById('editModal').style.display = 'flex';
        }

        function openDeleteModal(id) {
            currentDeleteId = id;
            document.getElementById('deletePassword').value = '';
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
            currentEditId = null;
            currentDeleteId = null;
        }

        async function confirmEdit() {
            const newTitle = document.getElementById('editTitle').value.trim();
            const password = document.getElementById('editPassword').value.trim();
            
            if (!newTitle) {
                alert('내용을 입력해주세요.');
                return;
            }
            
            if (!password) {
                alert('비밀번호를 입력해주세요.');
                return;
            }

            try {
                // 비밀번호 확인
                const { data: checkData, error: checkError } = await supabase
                    .from('newreports')
                    .select('password')
                    .eq('id', currentEditId)
                    .single();

                if (checkError) throw checkError;

                if (checkData.password !== password) {
                    alert('비밀번호가 일치하지 않습니다.');
                    return;
                }

                // 제목 수정
                const { data, error } = await supabase
                    .from('newreports')
                    .update({ 
                        title: newTitle,
                        date: getCurrentDateTime() + ' (수정됨)'
                    })
                    .eq('id', currentEditId)
                    .select();

                if (error) throw error;

                // 로컬 배열도 업데이트
                const index = reports.findIndex(r => r.id === currentEditId);
                if (index !== -1) {
                    reports[index] = { ...reports[index], title: newTitle, date: getCurrentDateTime() + ' (수정됨)' };
                    renderReports();
                }

                closeModal();
                alert('수정되었습니다.');

            } catch (error) {
                console.error('수정 오류:', error);
                alert('수정 중 오류가 발생했습니다.');
            }
        }

        async function confirmDelete() {
            const password = document.getElementById('deletePassword').value.trim();
            
            if (!password) {
                alert('비밀번호를 입력해주세요.');
                return;
            }

            try {
                // 비밀번호 확인
                const { data: checkData, error: checkError } = await supabase
                    .from('newreports')
                    .select('password')
                    .eq('id', currentDeleteId)
                    .single();

                if (checkError) throw checkError;

                if (checkData.password !== password) {
                    alert('비밀번호가 일치하지 않습니다.');
                    return;
                }

                // 게시글 삭제
                const { error } = await supabase
                    .from('newreports')
                    .delete()
                    .eq('id', currentDeleteId);

                if (error) throw error;

                // 로컬 배열에서도 제거
                reports = reports.filter(r => r.id !== currentDeleteId);
                renderReports();

                closeModal();
                alert('삭제되었습니다.');

            } catch (error) {
                console.error('삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료, 데이터 로딩 시작');
            loadReports();
            // 엔터키 이벤트
            document.getElementById('title').addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    // 비밀번호 체크 후 전송
                    const title = document.getElementById('title').value.trim();
                    const password = document.getElementById('password').value.trim();
        
                    if (!title) {
                        alert('내용을 입력해 주세요.');
                        return;
                    }
        
                    if (!password) {
                        alert('비밀번호를 입력해 주세요.');
                        document.getElementById('password').focus();
                        return;
                    }

                    document.getElementById('submitBtn').click();
                }
            });

            // 자동 높이 조절
            document.getElementById('title').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // 실시간 업데이트
        supabase
            .channel('newreports_channel')
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('새 게시글 실시간 수신:', payload.new);
                    reports.unshift(payload.new);
                    renderReports();
                }
            )
            .on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('게시글 수정 실시간 수신:', payload.new);
                    const index = reports.findIndex(r => r.id === payload.new.id);
                    if (index !== -1) {
                        reports[index] = payload.new;
                        renderReports();
                    }
                }
            )
            .on('postgres_changes', 
                { event: 'DELETE', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('게시글 삭제 실시간 수신:', payload.old);
                    reports = reports.filter(r => r.id !== payload.old.id);
                    renderReports();
                }
            )
            .subscribe();

        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (event.target === editModal || event.target === deleteModal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
