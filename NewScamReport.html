<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆë¡œìš´ ì‚¬ê¸°ìˆ˜ë²•ì„ ì œë³´í•©ë‹ˆë‹¤</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
            <h1>ìƒˆë¡œìš´ ì‚¬ê¸°ìˆ˜ë²• ì œë³´ ê²Œì‹œíŒ</h1>
        </div>

        <div class="write-form">
            <form onsubmit="submitReport(event)">
                <div class="form-row">
                    <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="100" required>
                    <button type="submit" class="submit-btn" id="submitBtn">ğŸ“ ì œì¶œí•˜ê¸°</button>
                </div>
            </form>
        </div>

        <div id="successMessage" style="display: none;"></div>

        <div class="board-list">
            <div id="boardList">
                <div class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="board-stats">
                Copyright Â© 2025 sagitapa. All rights reserved.
            </div>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://rmulijeebyohilnyqkev.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtdWxpamVlYnlvaGlsbnlxa2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTAwODMsImV4cCI6MjA2NzI4NjA4M30.Cf4mZutF14QVT7bfY1GJk6iBkKT8ALUA0uGkvLHKWDg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let reports = [];

        // í˜ì´ì§€ ë¡œë“œì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadReports() {
            try {
                console.log('ë°ì´í„° ë¡œë”© ì‹œì‘...');
                
                const { data, error } = await supabase
                    .from('newreports')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase ì˜¤ë¥˜:', error);
                    throw error;
                }
                
                console.log('ë¡œë“œëœ ë°ì´í„°:', data);
                reports = data || [];
                renderReports();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                
                // ì—°ê²° ì‹¤íŒ¨ì‹œ ì•Œë¦¼ í‘œì‹œ
                const boardList = document.getElementById('boardList');
                boardList.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px; font-size: 11px;">
                        ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>
                        <button onclick="loadReports()" style="margin-top: 10px; padding: 5px 10px; font-size: 10px;">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        function getCurrentDateTime() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const period = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const displayHours = String(hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours)).padStart(2, '0');
            
            return `${year}. ${month}. ${day}. ${period} ${displayHours}:${minutes}`;
        }

        async function submitReport(event) {
            event.preventDefault();
            
            const titleInput = document.getElementById('title');
            const submitBtn = document.getElementById('submitBtn');
            const title = titleInput.value.trim();
            
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                console.log('ë°ì´í„° ì €ì¥ ì‹œì‘:', title);
                
                // Supabaseì— ë°ì´í„° ì €ì¥
                const { data, error } = await supabase
                    .from('newreports')
                    .insert([
                        {
                            title: title,
                            date: getCurrentDateTime()
                        }
                    ])
                    .select();

                if (error) {
                    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                    throw error;
                }

                console.log('ì €ì¥ ì„±ê³µ:', data);

                // ì„±ê³µì‹œ ë¡œì»¬ ë°°ì—´ì—ë„ ì¶”ê°€
                if (data && data[0]) {
                    reports.unshift(data[0]);
                    renderReports();
                }
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const successMsg = document.getElementById('successMessage');
                successMsg.innerHTML = '<div class="success-message">ì œë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                successMsg.style.display = 'block';
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
                
                // í¼ ì´ˆê¸°í™”
                titleInput.value = '';
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + error.message);
            } finally {
                // ì œì¶œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ“ ì œì¶œí•˜ê¸°';
            }
        }

        function renderReports() {
            const boardList = document.getElementById('boardList');
            
            if (reports.length === 0) {
                boardList.innerHTML = '<div class="no-posts">ë“±ë¡ëœ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            boardList.innerHTML = reports.map(report => `
                <div class="board-item">
                    <div style="display: flex; align-items: center;">
                        <span class="board-number">No.${report.id}</span>
                        <span class="board-title">${report.title || '(ì œëª© ì—†ìŒ)'}</span>
                    </div>
                    <span class="board-date">${report.date}</span>
                </div>
            `).join('');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ë°ì´í„° ë¡œë”© ì‹œì‘');
            loadReports();
        });

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ê²Œì‹œê¸€ ì‹¤ì‹œê°„ ë°˜ì˜)
        supabase
            .channel('newreports_channel')
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('ìƒˆ ê²Œì‹œê¸€ ì‹¤ì‹œê°„ ìˆ˜ì‹ :', payload.new);
                    // ìƒˆ ê²Œì‹œê¸€ì„ ë§¨ ì•ì— ì¶”ê°€
                    reports.unshift(payload.new);
                    renderReports();
                }
            )
            .subscribe();
    </script>
</body>
</html>
