<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆë¡œìš´ ì‚¬ê¸°ìˆ˜ë²•ì„ ì œë³´í•©ë‹ˆë‹¤</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
            <h1>ìƒˆë¡œìš´ ì‚¬ê¸°ìˆ˜ë²•ì„ ì œë³´í•©ë‹ˆë‹¤</h1>
        </div>

        <div class="write-form">
            <form onsubmit="submitReport(event)">
                <div class="form-row">
                    <textarea id="title" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="100" required rows="1"></textarea>
            </div>
            <div class="form-row">
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="20" required>
                <button type="submit" class="submit-btn" id="submitBtn">ğŸ“ ì œì¶œí•˜ê¸°</button>
            </div>
        </form>
    </div>

        <div id="successMessage" style="display: none;"></div>

        <div class="board-list">
            <div id="boardList">
                <div class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="board-stats">
                Copyright Â© 2025 sagitapa. All rights reserved.
            </div>
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">ê²Œì‹œê¸€ ìˆ˜ì •</div>
            <div class="modal-body">
                <input type="text" id="editTitle" class="modal-input" placeholder="ìˆ˜ì •í•  ì œëª©">
                <input type="password" id="editPassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn primary" onclick="confirmEdit()">ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ ëª¨ë‹¬ -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">ê²Œì‹œê¸€ ì‚­ì œ</div>
            <div class="modal-body">
                <p>ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <input type="password" id="deletePassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn primary" onclick="confirmDelete()">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://rmulijeebyohilnyqkev.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtdWxpamVlYnlvaGlsbnlxa2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTAwODMsImV4cCI6MjA2NzI4NjA4M30.Cf4mZutF14QVT7bfY1GJk6iBkKT8ALUA0uGkvLHKWDg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let reports = [];
        let currentEditId = null;
        let currentDeleteId = null;

        // í˜ì´ì§€ ë¡œë“œì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadReports() {
            try {
                console.log('ë°ì´í„° ë¡œë”© ì‹œì‘...');
                
                const { data, error } = await supabase
                    .from('newreports')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase ì˜¤ë¥˜:', error);
                    throw error;
                }
                
                console.log('ë¡œë“œëœ ë°ì´í„°:', data);
                reports = data || [];
                renderReports();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                reports = [];
                renderReports();
            }
        }

        function getCurrentDateTime() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const period = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const displayHours = String(hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours)).padStart(2, '0');
            
            return `${year}. ${month}. ${day}. ${period} ${displayHours}:${minutes}`;
        }

        async function submitReport(event) {
            event.preventDefault();
            
            const titleInput = document.getElementById('title');
            const passwordInput = document.getElementById('password');
            const submitBtn = document.getElementById('submitBtn');
            const title = titleInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!title) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'ë“±ë¡ ì¤‘...';

            try {
                console.log('ë°ì´í„° ì €ì¥ ì‹œì‘:', title);
                
                const { data, error } = await supabase
                    .from('newreports')
                    .insert([
                        {
                            title: title,
                            password: password,
                            date: getCurrentDateTime()
                        }
                    ])
                    .select();

                if (error) {
                    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                    throw error;
                }

                console.log('ì €ì¥ ì„±ê³µ:', data);

                if (data && data[0]) {
                    reports.unshift(data[0]);
                    renderReports();
                }
                
                titleInput.value = '';
                passwordInput.value = '';
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ“ ë“±ë¡í•˜ê¸°';
            }
        }

        function renderReports() {
            const boardList = document.getElementById('boardList');
            
            if (reports.length === 0) {
                boardList.innerHTML = '<div class="no-posts">ë“±ë¡ëœ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            boardList.innerHTML = reports.map(report => `
                <div class="board-item">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <span class="board-number">No.${report.id || '?'}</span>
                        <span class="board-title">${report.title || '(ì œëª© ì—†ìŒ)'}</span>
                        <div class="board-actions">
                            <button class="action-btn edit-btn" onclick="openEditModal(${report.id}, '${report.title}')">ìˆ˜ì •</button>
                            <button class="action-btn delete-btn" onclick="openDeleteModal(${report.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <span class="board-date">${report.date}</span>
                </div>
            `).join('');
        }

        function openEditModal(id, title) {
            currentEditId = id;
            document.getElementById('editTitle').value = title.replace(/'/g, "");
            document.getElementById('editPassword').value = '';
            document.getElementById('editModal').style.display = 'flex';
        }

        function openDeleteModal(id) {
            currentDeleteId = id;
            document.getElementById('deletePassword').value = '';
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
            currentEditId = null;
            currentDeleteId = null;
        }

        async function confirmEdit() {
            const newTitle = document.getElementById('editTitle').value.trim();
            const password = document.getElementById('editPassword').value.trim();
            
            if (!newTitle) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                const { data: checkData, error: checkError } = await supabase
                    .from('newreports')
                    .select('password')
                    .eq('id', currentEditId)
                    .single();

                if (checkError) throw checkError;

                if (checkData.password !== password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì œëª© ìˆ˜ì •
                const { data, error } = await supabase
                    .from('newreports')
                    .update({ 
                        title: newTitle,
                        date: getCurrentDateTime() + ' (ìˆ˜ì •ë¨)'
                    })
                    .eq('id', currentEditId)
                    .select();

                if (error) throw error;

                // ë¡œì»¬ ë°°ì—´ë„ ì—…ë°ì´íŠ¸
                const index = reports.findIndex(r => r.id === currentEditId);
                if (index !== -1) {
                    reports[index] = { ...reports[index], title: newTitle, date: getCurrentDateTime() + ' (ìˆ˜ì •ë¨)' };
                    renderReports();
                }

                closeModal();
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function confirmDelete() {
            const password = document.getElementById('deletePassword').value.trim();
            
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                const { data: checkData, error: checkError } = await supabase
                    .from('newreports')
                    .select('password')
                    .eq('id', currentDeleteId)
                    .single();

                if (checkError) throw checkError;

                if (checkData.password !== password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê²Œì‹œê¸€ ì‚­ì œ
                const { error } = await supabase
                    .from('newreports')
                    .delete()
                    .eq('id', currentDeleteId);

                if (error) throw error;

                // ë¡œì»¬ ë°°ì—´ì—ì„œë„ ì œê±°
                reports = reports.filter(r => r.id !== currentDeleteId);
                renderReports();

                closeModal();
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ë°ì´í„° ë¡œë”© ì‹œì‘');
            loadReports();
            // ì—”í„°í‚¤ ì´ë²¤íŠ¸
            document.getElementById('title').addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    // ë¹„ë°€ë²ˆí˜¸ ì²´í¬ í›„ ì „ì†¡
                    const title = document.getElementById('title').value.trim();
                    const password = document.getElementById('password').value.trim();
        
                    if (!title) {
                        alert('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                        return;
                    }
        
                    if (!password) {
                        alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                        document.getElementById('password').focus();
                        return;
                    }

                    document.getElementById('submitBtn').click();
                }
            });

            // ìë™ ë†’ì´ ì¡°ì ˆ
            document.getElementById('title').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        supabase
            .channel('newreports_channel')
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('ìƒˆ ê²Œì‹œê¸€ ì‹¤ì‹œê°„ ìˆ˜ì‹ :', payload.new);
                    reports.unshift(payload.new);
                    renderReports();
                }
            )
            .on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤ì‹œê°„ ìˆ˜ì‹ :', payload.new);
                    const index = reports.findIndex(r => r.id === payload.new.id);
                    if (index !== -1) {
                        reports[index] = payload.new;
                        renderReports();
                    }
                }
            )
            .on('postgres_changes', 
                { event: 'DELETE', schema: 'public', table: 'newreports' }, 
                (payload) => {
                    console.log('ê²Œì‹œê¸€ ì‚­ì œ ì‹¤ì‹œê°„ ìˆ˜ì‹ :', payload.old);
                    reports = reports.filter(r => r.id !== payload.old.id);
                    renderReports();
                }
            )
            .subscribe();

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (event.target === editModal || event.target === deleteModal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
